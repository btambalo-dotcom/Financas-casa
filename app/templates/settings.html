{% extends "layout.html" %}
{% set title = "Configurações" %}
{% set header = "Configurações" %}
{% set subtitle = "Categorias, contas, usuários e recorrências" %}

{% block content %}

<div class="alert alert-info d-flex flex-wrap align-items-center justify-content-between gap-2">
  <div>
    <div class="fw-semibold">Diagnóstico</div>
    <div class="small">Use se “sumiu” dados ou após deploy no Render.</div>
  </div>
  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('bp.admin_diagnostico') }}">
    <i class="bi bi-activity"></i> Abrir diagnóstico
  </a>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Categorias</div>
      <div class="card-body">
        <form class="row g-2 mb-3" method="post" action="{{ url_for('bp.add_category') }}">
          <div class="col-md-6">
            <input class="form-control" name="name" placeholder="Nova categoria" required>
          </div>
          <div class="col-md-4">
            <select class="form-select" name="kind">
              <option value="expense">Despesa</option>
              <option value="income">Receita</option>
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary">Adicionar</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Nome</th><th>Tipo</th><th>Status</th></tr>
            </thead>
            <tbody>
              {% for c in cats %}
                <tr>
                  <td>{{ c.name }}</td>
                  <td>{{ "Receita" if c.kind=="income" else "Despesa" }}</td>
                  <td><span class="badge text-bg-{{ 'success' if c.is_active else 'secondary' }}">{{ "Ativa" if c.is_active else "Inativa" }}</span></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Contas</div>
      <div class="card-body">
        <form class="row g-2 mb-3" method="post" action="{{ url_for('bp.add_account') }}">
          <div class="col-md-6">
            <input class="form-control" name="name" placeholder="Nova conta" required>
          </div>
          <div class="col-md-4">
            <select class="form-select" name="kind">
              <option value="checking">Conta Corrente</option>
              <option value="credit">Cartão</option>
              <option value="cash">Dinheiro</option>
              <option value="savings">Poupança</option>
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary">Adicionar</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Nome</th><th>Tipo</th><th>Status</th></tr>
            </thead>
            <tbody>
              {% for a in accs %}
                <tr>
                  <td>{{ a.name }}</td>
                  <td>{{ a.kind }}</td>
                  <td><span class="badge text-bg-{{ 'success' if a.is_active else 'secondary' }}">{{ "Ativa" if a.is_active else "Inativa" }}</span></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Usuários</div>
      <div class="card-body">

        <form class="row g-2 mb-3" method="post" action="{{ url_for('bp.add_user') }}">
          <div class="col-md-3">
            <input class="form-control" name="name" placeholder="Nome" required>
          </div>
          <div class="col-md-2">
            <input class="form-control" name="username" placeholder="Usuário (login)" required>
          </div>
          <div class="col-md-2">
            <input class="form-control" name="password" placeholder="Senha" required>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="role">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary"><i class="bi bi-person-plus me-1"></i>Criar usuário</button>
          </div>
        </form>

        <form class="row g-2 mb-3" method="post" action="{{ url_for('bp.set_user_password') }}">
          <div class="col-md-4">
            <select class="form-select" name="user_id" required>
              <option value="">Selecione para trocar senha...</option>
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }} ({{ u.role }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <input class="form-control" name="new_password" placeholder="Nova senha (mín 4)" required>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-outline-primary"><i class="bi bi-key me-1"></i>Atualizar senha</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light"><tr><th>Usuário</th><th>Nome</th><th>Role</th><th class="text-end">Ações</th></tr></thead>
            <tbody>
              {% for u in users %}
                <tr>
                  <td>{{ u.username }}</td>
                  <td>{{ u.name }}</td>
                  <td><span class="badge text-bg-{{ 'primary' if u.role=='admin' else 'secondary' }}">{{ u.role }}</span></td>
                  <td class="text-end">
                    {% if u.id != session.get('user_id') %}
                      <form class="d-inline" method="post" action="{{ url_for('bp.delete_user', uid=u.id) }}" onsubmit="return confirm('Excluir o usuário {{ u.username }}?');">
                        <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                      </form>
                    {% else %}
                      <span class="text-muted small">logado</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="form-text mt-2">
          Não é possível excluir o usuário logado nem o último administrador.
        </div>

      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Despesas/Receitas recorrentes (entram todo mês automaticamente)</div>
      <div class="card-body">

        <form class="row g-2 mb-3" method="post" action="{{ url_for('bp.add_recurring') }}">
          <div class="col-md-2">
            <input class="form-control" name="name" placeholder="Nome (ex: Aluguel)" required>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="txn_type">
              <option value="expense">Despesa</option>
              <option value="income">Receita</option>
            </select>
          </div>
          <div class="col-md-2">
            <input class="form-control" type="number" step="0.01" name="amount" placeholder="Valor" required>
          </div>
          <div class="col-md-1">
            <input class="form-control" type="number" name="day_of_month" value="1" min="1" max="31" title="Dia do mês">
          </div>
          <div class="col-md-2">
            <select class="form-select" name="category_id" required>
              <option value="">Categoria...</option>
              <optgroup label="Despesas">
                {% for c in cats_expense %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </optgroup>
              <optgroup label="Receitas">
                {% for c in cats_income %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </optgroup>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="account_id" required>
              <option value="">Conta...</option>
              {% for a in accs %}
                <option value="{{ a.id }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-1 d-grid">
            <button class="btn btn-primary" title="Adicionar"><i class="bi bi-plus-lg"></i></button>
          </div>
          <div class="col-12">
            <input class="form-control" name="description" placeholder="Descrição (opcional)">
            <div class="form-text">Obs: elas são geradas automaticamente quando você abrir o mês no Dashboard/Lançamentos.</div>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Nome</th><th>Tipo</th><th>Dia</th><th>Categoria</th><th>Conta</th><th class="text-end">Valor</th><th class="text-end">Ações</th></tr>
            </thead>
            <tbody>
              {% for r in recurring %}
                <tr>
                  <td>{{ r.name }}</td>
                  <td><span class="badge text-bg-{{ 'success' if r.txn_type=='income' else 'danger' }}">{{ r.txn_type }}</span></td>
                  <td>{{ r.day_of_month }}</td>
                  <td>{{ r.category.name }}</td>
                  <td>{{ r.account.name }}</td>
                  <td class="text-end">${{ '%.2f'|format(r.amount) }}</td>
                  <td class="text-end">
                    <form class="d-inline" method="post" action="{{ url_for('bp.delete_recurring', rid=r.id) }}" onsubmit="return confirm('Remover recorrência {{ r.name }}?');">
                      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </form>
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="7" class="text-muted p-3">Nenhuma recorrência cadastrada.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}