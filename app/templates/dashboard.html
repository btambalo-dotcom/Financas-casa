{% extends "layout.html" %}
{% set title = "Dashboard" %}
{% set header = "Dashboard" %}
{% set subtitle = "Visão geral do mês e do orçamento" %}

{% block content %}
<form class="row g-2 align-items-end mb-3" method="get" action="{{ url_for('bp.dashboard') }}">
  <div class="col-auto">
    <label class="form-label">Mês (YYYY-MM)</label>
    <input class="form-control" name="month" value="{{ month }}" placeholder="2025-12">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary"><i class="bi bi-search me-1"></i>Ver</button>
  </div>
</form>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Orçamento planejado</div>
        <div class="display-6">${{ '%.2f'|format(planned) }}</div>
        <div class="text-muted small mt-2">Saldo do orçamento (planejado - gasto)</div>
        <div class="h4 {{ 'text-success' if budget_balance>=0 else 'text-danger' }}">${{ '%.2f'|format(budget_balance) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Receitas do mês</div>
        <div class="h2">${{ '%.2f'|format(income) }}</div>
        <div class="text-muted small mt-2">Despesas do mês</div>
        <div class="h2">${{ '%.2f'|format(spent) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Saldo financeiro (receita - despesa)</div>
        <div class="display-6 {{ 'text-success' if balance>=0 else 'text-danger' }}">${{ '%.2f'|format(balance) }}</div>
        <div class="text-muted small mt-2">Ação rápida</div>
        <a class="btn btn-outline-primary" href="{{ url_for('bp.transactions_new') }}"><i class="bi bi-plus-circle me-1"></i>Novo lançamento</a>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="fw-semibold">Orçamento por categoria</div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Categoria</th>
              <th class="text-end">Planejado</th>
              <th class="text-end">Gasto</th>
              <th class="text-end">Saldo</th>
            </tr>
          </thead>
          <tbody>
          {% for r in budget_rows %}
            <tr>
              <td>{{ r.category }}</td>
              <td class="text-end">${{ '%.2f'|format(r.planned) }}</td>
              <td class="text-end">${{ '%.2f'|format(r.spent) }}</td>
              <td class="text-end fw-semibold {{ 'text-success' if r.remaining>=0 else 'text-danger' }}">${{ '%.2f'|format(r.remaining) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-muted p-3">Sem orçamentos cadastrados para este mês.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-body bg-white">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('bp.budgets', month=month) }}"><i class="bi bi-gear me-1"></i>Gerenciar orçamentos</a>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between">
        <div class="fw-semibold">Últimos lançamentos</div>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('bp.transactions_list', month=month) }}">Ver todos</a>
      </div>
      <div class="list-group list-group-flush">
        {% for t in recent %}
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ t.category.name }} <span class="text-muted">• {{ t.account.name }}</span></div>
              <div class="text-muted small">{{ t.txn_date }} — {{ t.description or "—" }}</div>
            </div>
            <div class="fw-bold {{ 'text-danger' if t.txn_type=='expense' else 'text-success' }}">
              {{ '-' if t.txn_type=='expense' else '+' }}${{ '%.2f'|format(t.amount) }}
            </div>
          </div>
        {% else %}
          <div class="list-group-item text-muted">Sem lançamentos ainda.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}