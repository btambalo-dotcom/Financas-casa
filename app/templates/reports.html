{% extends "layout.html" %}
{% set title = "Relatórios" %}
{% set header = "Relatórios" %}
{% set subtitle = "Resumo por categoria e por conta" %}

{% block header_actions %}
  <a class="btn btn-outline-secondary" href="{{ url_for('bp.reports_export', fmt='csv', month=month) }}"><i class="bi bi-download me-1"></i>CSV</a>
  <a class="btn btn-outline-secondary" href="{{ url_for('bp.reports_export', fmt='xlsx', month=month) }}"><i class="bi bi-file-earmark-excel me-1"></i>Excel</a>
  <a class="btn btn-outline-secondary" href="{{ url_for('bp.reports_export', fmt='pdf', month=month) }}"><i class="bi bi-filetype-pdf me-1"></i>PDF</a>
{% endblock %}

{% block content %}
<form class="row g-2 align-items-start mb-3" method="get" action="{{ url_for('bp.reports') }}">
  <div class="col-12 col-lg-2">
    <label class="form-label">Mês (YYYY-MM)</label>
    <input class="form-control" name="month" value="{{ month }}" placeholder="2025-12">
    <div class="form-text">Opcional se usar período.</div>
  </div>

  <div class="col-6 col-lg-2">
    <label class="form-label">De (YYYY-MM-DD)</label>
    <input class="form-control" type="date" name="date_from" value="{{ date_from }}">
  </div>

  <div class="col-6 col-lg-2">
    <label class="form-label">Até (YYYY-MM-DD)</label>
    <input class="form-control" type="date" name="date_to" value="{{ date_to }}">
  </div>

  <div class="col-6 col-lg-2">
    <label class="form-label">Tipo</label>
    <select class="form-select" name="txn_type">
      <option value="all" {% if txn_type=='all' %}selected{% endif %}>Todos</option>
      <option value="income" {% if txn_type=='income' %}selected{% endif %}>Receitas</option>
      <option value="expense" {% if txn_type=='expense' %}selected{% endif %}>Despesas</option>
    </select>
  </div>

  <div class="col-6 col-lg-2">
    <label class="form-label">Conta</label>
    <select class="form-select" name="account_id">
      <option value="all" {% if account_id=='all' %}selected{% endif %}>Todas</option>
      {% for a in accounts %}
        <option value="{{ a.id }}" {% if account_id|int == a.id %}selected{% endif %}>{{ a.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-12 col-lg-2">
    <label class="form-label">Categoria (multi)</label>
    <select class="form-select" name="category_id" multiple size="4">
      {% for c in categories %}
        <option value="{{ c.id }}" {% if c.id in category_ids %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-12 d-flex gap-2 mt-2">
    <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Aplicar filtros</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('bp.reports', month=month) }}">Limpar</a>

    <div class="ms-auto d-flex flex-wrap gap-2">
      <a class="btn btn-outline-dark" href="{{ url_for('bp.reports_export', fmt='pdf', **export_params) }}"><i class="bi bi-filetype-pdf"></i> PDF</a>
      <a class="btn btn-outline-success" href="{{ url_for('bp.reports_export', fmt='xlsx', **export_params) }}"><i class="bi bi-file-earmark-excel"></i> Excel</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('bp.reports_export', fmt='csv', **export_params) }}"><i class="bi bi-filetype-csv"></i> CSV</a>
    </div>
  </div>
</form>

<div class="alert alert-light border d-flex justify-content-between align-items-center mb-3">
  <div><strong>Filtro atual:</strong> {{ label }}</div>
  <div class="small text-muted">Dica: para recorrentes, use a tela de “Orçamentos”.</div>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Por categoria</div>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="table-light"><tr><th>Tipo</th><th>Categoria</th><th class="text-end">Total</th></tr></thead>
          <tbody>
            {% for typ, cat, total in cat_rows %}
              <tr>
                <td><span class="badge text-bg-{{ 'success' if typ=='income' else 'danger' }}">{{ 'Receita' if typ=='income' else 'Despesa' }}</span></td>
                <td>{{ cat }}</td>
                <td class="text-end fw-semibold">${{ '%.2f'|format(total) }}</td>
              </tr>
            {% else %}
              <tr><td colspan="3" class="text-muted p-3">Sem dados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Por conta</div>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="table-light"><tr><th>Tipo</th><th>Conta</th><th class="text-end">Total</th></tr></thead>
          <tbody>
            {% for typ, acc, total in acc_rows %}
              <tr>
                <td><span class="badge text-bg-{{ 'success' if typ=='income' else 'danger' }}">{{ 'Receita' if typ=='income' else 'Despesa' }}</span></td>
                <td>{{ acc }}</td>
                <td class="text-end fw-semibold">${{ '%.2f'|format(total) }}</td>
              </tr>
            {% else %}
              <tr><td colspan="3" class="text-muted p-3">Sem dados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}